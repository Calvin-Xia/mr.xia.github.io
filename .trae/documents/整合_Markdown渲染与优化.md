# Markdown渲染与优化

## Markdown渲染系统

### 核心技术栈
- **marked.js v11.1.1**: Markdown解析器，支持GFM和breaks配置
- **highlight.js v11.9.0**: 代码语法高亮，使用github-dark主题
- **KaTeX v0.16.9**: 数学公式渲染，支持$和$$分隔符
- 完整的CSS样式系统

### 渲染配置优化
分析breaks配置对各种内容的影响：

- **breaks: true**: 将单个换行符转换为`<br>`标签
- **breaks: false**: 保持Markdown标准行为
- **数学公式**: breaks:true会导致KaTeX无法识别$$分隔符
- **推荐方案**: 使用breaks: false，符合Markdown标准规范
- **缓解措施**: 更新使用说明，提供标准换行语法示例

### 图片处理功能

#### 图片备注文本显示
- 同时处理HTML格式`<img src="..." alt="备注">`和Markdown格式`![备注](image.jpg)`
- 为每张图片下方添加备注文本
- 字体大小0.85em，使用次要文本颜色
- 居中显示，适当间距

#### 图片预加载优化
- 在折叠状态下提前加载图片
- 使用渐进式加载策略（优先首图，然后其他图片）
- 检测网络连接速度，智能调整预加载策略
- 慢速网络只预加载首图，快速网络预加载所有图片
- 添加加载状态提示

#### 图片尺寸修复
- 修复HTML格式图片的百分比宽度问题
- 处理flex容器内的图片布局
- 保留原有的60%、48%、32%等比例关系
- 确保备注文本正确显示在图片下方

### 折叠/展开功能

#### 折叠预览
- 生成折叠预览内容
- 提取所有图片URL进行预加载
- 显示加载指示器
- 支持无缝切换

#### 状态管理
- 避免重复预加载
- 利用浏览器缓存
- 确保togglePreview()正确切换状态
- 防止功能丧失

### 导出功能

#### HTML导出优化
- 修复导出HTML中图片备注丢失的问题
- 在导出前先处理图片
- 创建临时DOM元素处理图片
- 确保导出的HTML包含所有图片备注

## 独立Markdown工具

### 单文件工具开发
创建独立的markdown-to-html-tool.html工具：

- 完整复刻statement.html的Markdown渲染效果
- 包含所有依赖、样式和功能
- 左右分栏布局（输入+预览）
- 实时预览更新

### 核心功能
- Markdown解析器配置（marked.setOptions）
- 代码高亮功能（hljs.highlightElement）
- 数学公式渲染（renderMathInElement）
- 图片处理（自动添加备注文本）
- 折叠/展开预览模式
- 图片预加载优化
- 导出为纯HTML文件

### UI界面
- 操作按钮（渲染、导出、清空等）
- 加载状态指示器
- 响应式设计
- 详细的使用文档和测试示例

## 性能优化

### 加载优化
- 使用Intersection Observer检测图片可见性
- 懒加载非首屏图片
- 网络连接速度检测
- 智能预加载策略

### 渲染优化
- 避免重复渲染
- 利用浏览器缓存
- 优化DOM操作
- 减少重排重绘
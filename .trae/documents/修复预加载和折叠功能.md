# 修复预加载和折叠功能问题

## 问题分析

### 1. 预加载图片数目不符

* **问题**：计数逻辑在onload和onerror中都会递增，导致显示数量与实际不符

* **影响**：用户看到错误的预加载进度

### 2. 弹窗持续显示

* **问题**：只有当计数达到limit时才隐藏，如果所有图片加载失败则弹窗不消失

* **影响**：加载指示器一直显示，影响用户体验

### 3. 重复预加载

* **问题**：每次showCollapsed()都触发preloadImages()，导致重复加载

* **影响**：浪费带宽，降低性能

### 4. 图片重新加载

* **问题**：每次showExpanded()重新渲染，图片重新请求

* **影响**：展开时加载延迟，用户体验差

### 5. 折叠功能丧失

* **问题**：状态管理不完善，可能导致功能失效

* **影响**：核心功能不稳定

## 修复方案

### 1. 修复计数逻辑

* 只在onload时递增计数

* 添加超时机制：3秒后自动隐藏弹窗

### 2. 添加预加载状态管理

* 新增`hasPreloaded`标志

* 避免重复预加载已加载的图片

### 3. 删除加载指示器

* 降低用户卡顿感知

### 4. 改进状态管理

* 确保togglePreview()正确切换状态

* 防止功能丧失

## 预期效果

✅ 预加载计数准确
✅ 弹窗正确隐藏
✅ 避免重复预加载
✅ 图片利用缓存
✅ 折叠功能稳定

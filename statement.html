<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mr.Xiaä¸ªäººç½‘ç«™å£°æ˜">
    <title>ç½‘ç«™å£°æ˜ - Mr.Xia</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- å¼•å…¥Markdownæ¸²æŸ“ç›¸å…³åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
</head>
<body>
    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <div class="bg-img"></div>

    <!-- é¡µçœ‰å¯¼èˆª -->
    <header>
        <nav>
            <div class="logo">Mr.Xia</div>
            <ul class="nav-links">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="Works.html">ä½œå“</a></li>
                <li><a href="timetable.html">å·¥å…·</a></li>
                <li><a href="statement.html">æ–‡ç« </a></li>
                <li><a href="about.html">å…³äº</a></li>
            </ul>
        </nav>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main>
        <section>
            <h1>ç½‘ç«™å£°æ˜ ğŸ“‹</h1>
            <p class="text-small" style="margin-bottom: var(--spacing-lg);">
                æœ€åæ›´æ–°æ—¶é—´ï¼š2025å¹´12æœˆ31æ—¥
            </p>
        </section>

        <!-- Markdownå±•ç¤ºæ¡† -->
        <div class="shadowbox markdown-container">
            <h2 style="text-align: center; margin-bottom: var(--spacing-lg);">
                ğŸ“ 2025å¹´åº¦æ€»ç»“
            </h2>

            <!-- åˆ‡æ¢æŒ‰é’® -->
            <div style="text-align: center; margin-bottom: var(--spacing-md);">
                <button id="toggle-preview" class="btn btn-outline" onclick="MarkdownRenderer.togglePreview()">
                    <span id="toggle-icon">ğŸ“–</span>
                    <span id="toggle-text">å±•å¼€å…¨æ–‡</span>
                </button>
            </div>

            <!-- æ¸²æŸ“ç»“æœ -->
            <div id="markdown-output" class="markdown-content">
                <p style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</p>
            </div>
        </div>


    </main>

    <!-- JavaScript -->
    <script src="js/main.js"></script>
    <script>
        // Markdowné™æ€æ¸²æŸ“åŠŸèƒ½
        const MarkdownRenderer = {
            init() {
                this.outputElement = document.getElementById('markdown-output');
                this.isCollapsed = true;
                this.fullContent = '';
                this.collapsedContent = '';
                this.preloadedImages = new Set();
                this.preloadTimeout = null;
                this.hasPreloaded = false;

                if (!this.outputElement) {
                    console.error('Markdown output element not found');
                    return;
                }

                console.log('MarkdownRenderer initialized');

                // é…ç½®markedé€‰é¡¹
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });

                // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¸²æŸ“æŒ‡å®šè·¯å¾„çš„markdownæ–‡ä»¶
                this.loadAndRender('storage/2025å¹´åº¦æ€»ç»“/2025å¹´åº¦æ€»ç»“.md');
            },

            async loadAndRender(filePath) {
                console.log('Loading markdown file:', filePath);
                try {
                    const response = await fetch(filePath);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const markdownText = await response.text();
                    console.log('Markdown file loaded, length:', markdownText.length);
                    this.render(markdownText);
                } catch (err) {
                    console.error('Markdown file load error:', err);
                    if (this.outputElement) {
                        this.outputElement.innerHTML = '<p style="color: var(--error-color); text-align: center;">æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿markdownæ–‡ä»¶å­˜åœ¨</p>';
                    }
                }
            },

            render(markdownText) {
                console.log('Rendering markdown...');
                this.fullContent = markdownText;
                
                const html = marked.parse(markdownText);
                this.outputElement.innerHTML = html;
                console.log('Markdown rendered, HTML length:', html.length);

                // ç”ŸæˆæŠ˜å é¢„è§ˆå†…å®¹
                this.generateCollapsedPreview();

                // é»˜è®¤æ˜¾ç¤ºæŠ˜å çŠ¶æ€
                if (this.isCollapsed) {
                    this.showCollapsed();
                } else {
                    this.showExpanded();
                }

                // æ¸²æŸ“æ•°å­¦å…¬å¼
                this.renderMath();

                // é«˜äº®ä»£ç å—
                this.highlightCode();

                // å¤„ç†å›¾ç‰‡ï¼Œæ·»åŠ å¤‡æ³¨æ–‡æœ¬
                this.processImages();

                console.log('Markdown rendering complete');
            },

            preloadImages() {
                let imageUrls = [];
                
                try {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = marked.parse(this.fullContent);
                    const images = tempDiv.querySelectorAll('img');
                    imageUrls = Array.from(images).map(img => img.src);
                    
                    tempDiv.innerHTML = '';
                } catch (err) {
                    console.warn('Failed to extract image URLs using DOM parsing:', err);
                    
                    const singleQuotePattern = /src=['"]([^'"]+)['"]/g;
                    const doubleQuotePattern = /src=["']([^"']+)["']/g;
                    
                    const singleQuoteUrls = this.fullContent.match(singleQuotePattern) || [];
                    const doubleQuoteUrls = this.fullContent.match(doubleQuotePattern) || [];
                    
                    imageUrls = [...(singleQuoteUrls || []), ...(doubleQuoteUrls || [])];
                }
                
                if (!imageUrls || imageUrls.length === 0) {
                    console.log('No images found to preload');
                    return;
                }

                console.log(`Found ${imageUrls.length} images to preload`);
                
                const connection = navigator.connection || { effectiveType: '4g' };
                const isSlowConnection = connection.effectiveType === 'slow-2g' || 
                                        connection.effectiveType === '2g' || 
                                        connection.effectiveType === '3g';
                
                const preloadLimit = isSlowConnection ? 3 : imageUrls.length;
                const loadingIndicator = document.getElementById('loading-indicator');
                const loadingText = document.getElementById('loading-text');
                
                if (loadingIndicator && loadingText) {
                    loadingIndicator.classList.add('active');
                    loadingText.textContent = `æ­£åœ¨é¢„åŠ è½½å›¾ç‰‡ (0/${preloadLimit})...`;
                }
                
                let preloadedCount = 0;
                
                imageUrls.slice(0, preloadLimit).forEach((url, index) => {
                    let cleanedUrl = url;
                    
                    cleanedUrl = cleanedUrl.replace(/%22/g, '').replace(/%22/g, '').trim();
                    cleanedUrl = cleanedUrl.replace(/&quot;/g, '').replace(/&quot;/g, '').trim();
                    cleanedUrl = decodeURIComponent(cleanedUrl);
                    cleanedUrl = cleanedUrl.replace(/%22/g, '').replace(/%22/g, '').trim();
                    
                    if (!cleanedUrl) {
                        console.warn(`Empty URL at index ${index}`);
                        return;
                    }
                    
                    const img = new Image();
                    img.src = cleanedUrl;
                    img.loading = 'eager';
                    
                    img.onload = () => {
                        this.preloadedImages.add(cleanedUrl);
                        preloadedCount++;
                        console.log(`Preloaded image ${preloadedCount}/${preloadLimit}: ${cleanedUrl}`);
                        
                        if (loadingText) {
                            loadingText.textContent = `æ­£åœ¨é¢„åŠ è½½å›¾ç‰‡ (${preloadedCount}/${preloadLimit})...`;
                        }
                        
                        if (preloadedCount === preloadLimit) {
                            setTimeout(() => {
                                if (loadingIndicator) {
                                    loadingIndicator.classList.remove('active');
                                }
                            }, 500);
                        }
                    };
                    
                    img.onerror = () => {
                        console.warn(`Failed to preload image: ${cleanedUrl}`);
                    };
                });
                
                this.preloadTimeout = setTimeout(() => {
                    if (loadingIndicator && loadingIndicator.classList.contains('active')) {
                        loadingIndicator.classList.remove('active');
                        console.log('Preload timeout reached, hiding loading indicator');
                    }
                }, 3000);
            },

            generateCollapsedPreview() {
                const lines = this.fullContent.split('\n');
                let previewContent = '';
                let firstImageAdded = false;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    if (line.startsWith('#')) {
                        previewContent += line + '\n';
                        if (i < 3) {
                            previewContent += '\n';
                        }
                    } else if (line.trim() && !firstImageAdded) {
                        previewContent += line + '\n';
                        if (line.trim().length > 10) {
                            break;
                        }
                    } else if (line.includes('<img') || line.includes('![')) {
                        previewContent += line + '\n';
                        firstImageAdded = true;
                        break;
                    }
                }

                this.collapsedContent = marked.parse(previewContent);
            },

            showCollapsed() {
                this.outputElement.innerHTML = this.collapsedContent;
                this.outputElement.classList.add('collapsed');
                this.outputElement.classList.remove('expanded');
                document.getElementById('toggle-icon').textContent = 'ğŸ“–';
                document.getElementById('toggle-text').textContent = 'å±•å¼€å…¨æ–‡';
                
                this.renderMath();
                this.highlightCode();
                this.processImages();
                
                if (!this.hasPreloaded) {
                    this.preloadImages();
                    this.hasPreloaded = true;
                }
            },

            showExpanded() {
                this.outputElement.innerHTML = marked.parse(this.fullContent);
                this.outputElement.classList.remove('collapsed');
                this.outputElement.classList.add('expanded');
                document.getElementById('toggle-icon').textContent = 'ğŸ“–';
                document.getElementById('toggle-text').textContent = 'æ”¶èµ·é¢„è§ˆ';
                
                this.renderMath();
                this.highlightCode();
                this.processImages();
            },

            togglePreview() {
                const wasCollapsed = this.isCollapsed;
                this.isCollapsed = !this.isCollapsed;
                
                if (this.isCollapsed) {
                    this.showCollapsed();
                } else {
                    this.showExpanded();
                }
                
                if (wasCollapsed !== this.isCollapsed) {
                    console.log(`Preview state changed: ${wasCollapsed ? 'collapsed' : 'expanded'} â†’ ${this.isCollapsed ? 'collapsed' : 'expanded'}`);
                }
            },

            renderMath() {
                try {
                    renderMathInElement(this.outputElement, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                } catch (err) {
                    console.warn('Math rendering error:', err);
                }
            },

            highlightCode() {
                try {
                    this.outputElement.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                } catch (err) {
                    console.warn('Code highlighting error:', err);
                }
            },

            processImages() {
                const flexWrappers = this.outputElement.querySelectorAll('div[style*="flex"]');
                
                flexWrappers.forEach(wrapper => {
                    const flexImages = wrapper.querySelectorAll('img');
                    
                    flexImages.forEach(img => {
                        const altText = img.getAttribute('alt');
                        if (altText) {
                            const originalStyle = img.getAttribute('style') || '';
                            const widthMatch = originalStyle.match(/width:\s*([\d.]+)%/);
                            const widthPercent = widthMatch ? widthMatch[1] + '%' : 'auto';
                            
                            const wrapperDiv = document.createElement('div');
                            wrapperDiv.style.cssText = `display: flex; flex-direction: column; align-items: center; width: ${widthPercent}; box-sizing: border-box;`;
                            
                            img.parentNode.insertBefore(wrapperDiv, img);
                            wrapperDiv.appendChild(img);
                            
                            const imgStyle = originalStyle.replace(/width:\s*[\d.]+%[^;]*;?\s*/g, '').trim();
                            if (imgStyle) {
                                img.setAttribute('style', imgStyle);
                            } else {
                                img.removeAttribute('style');
                            }
                            
                            const caption = document.createElement('div');
                            caption.className = 'image-caption';
                            caption.textContent = altText;
                            caption.style.marginTop = '4px';
                            caption.style.marginBottom = '0';
                            wrapperDiv.appendChild(caption);
                        }
                    });
                });
                
                const standaloneImages = this.outputElement.querySelectorAll('img');
                standaloneImages.forEach(img => {
                    if (!img.closest('[style*="flex"]')) {
                        const altText = img.getAttribute('alt');
                        if (altText && !img.nextElementSibling?.classList.contains('image-caption')) {
                            const caption = document.createElement('div');
                            caption.className = 'image-caption';
                            caption.textContent = altText;
                            caption.style.marginTop = '4px';
                            caption.style.marginBottom = '16px';
                            
                            if (img.parentNode) {
                                img.parentNode.insertBefore(caption, img.nextSibling);
                            }
                        }
                    }
                });
            }
        };

        // ä½¿ç”¨window.onloadç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆåå†æ¸²æŸ“
        window.addEventListener('load', () => {
            console.log('Window loaded, initializing MarkdownRenderer');
            MarkdownRenderer.init();
        });
    </script>
</body>
</html>